# 红外热释电人体感应泡泡机控制

## 目录
- [简介（Description）](#简介description)
- [主要功能（Features）](#主要功能features)
- [硬件要求（Hardware Requirements）](#硬件要求hardware-requirements)
- [软件环境（Software Environment）](#软件环境software-environment)
- [文件结构（File Structure）](#文件结构file-structure)
- [文件说明（File Description）](#文件说明file-description)
- [软件设计核心思想（Design Idea）](#软件设计核心思想design-idea)
- [使用说明（Quick Start）](#使用说明quick-start)
- [示例程序（Example）](#示例程序example)
- [注意事项（Notes）](#注意事项notes)
- [版本记录（Version History）](#版本记录version-history)
- [联系开发者（Contact）](#联系开发者contact)
- [许可协议（License）](#许可协议license)


## 简介（Description）
### 项目背景
传统泡泡机多依赖手动开关或定时控制，存在触发滞后、能耗较高、交互性弱等问题，难以满足儿童娱乐、场景互动等需求。本项目基于GraftPort-RP2040开发板，整合红外热释电传感器（PIR）、MOS管电机驱动（泡泡机执行）与状态指示模块，通过MicroPython实现“人体感应→自动启动→延时关闭”的智能控制流程，解决传统方案中“需手动操作、能耗浪费”的痛点。

### 项目主要功能概览
本项目核心功能是通过PIR传感器检测人体活动（3-5米感应范围），触发泡泡机电机启动；运行设定时间（默认5秒）后自动停止，随后进入3秒锁定期（避免重复触发）；支持板载按键暂停/恢复任务，通过LED指示设备状态（待机/运行/故障），适配家庭、儿童乐园等场景的自动互动需求。

### 适用场景或应用领域
- 儿童玩具：自动感应启动的泡泡机，减少儿童手动操作，提升玩耍趣味性；  
- 场景装饰：商场、游乐园的互动装置，有人靠近时自动出泡，增强场景吸引力；  
- 教学演示：用于嵌入式课程中“传感器应用、电机控制、任务调度”等知识点的实践。  


## 主要功能（Features）
- **人体感应触发**：PIR红外热释电传感器支持3-5米检测距离、110°感应角度，内置200ms防抖处理，区分人体移动与环境干扰；  
- **自动启停控制**：检测到人体后，驱动泡泡机电机运行5秒（可配置），随后进入3秒锁定期，避免短时间内重复触发；  
- **状态可视化反馈**：板载LED指示工作状态（绿色=待机、红色=运行、闪烁=故障），操作状态一目了然；  
- **任务中断管理**：板载按键触发下降沿中断，短按切换任务“运行/暂停”，暂停时关闭传感器检测与电机驱动；  
- **故障自检测**：传感器连接异常或电机堵转时，触发LED闪烁报警，提升设备可靠性；  
- **参数灵活配置**：通过`conf.py`调整电机运行时间、锁定期长度、感应灵敏度，适配不同场景需求。  


## 硬件要求（Hardware Requirements）
项目基于GraftPort-RP2040开发板作为主控：  

**所需模块清单**：  
- 感应模块：HC-SR501红外热释电传感器（PIR，数字输出）；  
- 执行模块：泡泡机直流电机 + 光耦MOS管驱动（PWM控制，支持12V以下电机）；  
- 指示模块：板载LED（至少2路，用于状态提示）；  
- 交互模块：板载按键（1路，用于任务暂停/恢复）；  
- 供电模块：5V锂电池 + 充放电模块（为主控及传感器供电，电机可单独接12V电源）。  

**连接方式**：  
1. PIR传感器：VCC接5V、GND接GND、OUT接GPIO输入引脚（参考`board.py`配置）；  
2. MOS管驱动：控制端接PWM引脚、电机正极接电源、负极接MOS管输出端、GND与主控共地；  
3. 板载按键：一端接GPIO引脚（上拉输入）、另一端接GND；

## 软件环境（Software Environment）
- 核心固件：MicroPython v1.23.0（适配GraftPort-RP2040，支持`machine.Pin/PWM/Timer`模块）；  
- 开发IDE：PyCharm（安装MicroPython插件，支持代码上传、REPL调试）；  
- 辅助工具：  
  - mpremote v0.11.0+（用于命令行文件传输与设备交互）；  
  - Python 3.10+（运行传感器校准脚本）；  
- 依赖模块：无第三方库，PIR传感器、MOS管驱动等均为项目自定义实现。  


## 文件结构（File Structure）
```
firmware/
├── board.py               # 板级支持文件，定义 GraftPort-RP2040 的引脚映射
├── conf.py                # 配置文件，存放可自定义参数（运行时间、锁定期等）
├── main.py                # 项目入口文件，负责硬件初始化、任务创建与调度启动
├── boot.py                # 启动脚本，初始化板载 LED，提示系统启动状态
├── drivers/               # 硬件驱动文件夹，封装各外设控制接口
│   ├── __init__.py         # 驱动包导出，简化外部调用
│   ├── pir_driver.py       # PIR 传感器驱动，提供人体感应检测与状态判断
│   └── opto_mos_driver.py  # 光耦 MOS 管驱动，控制泡泡机电机启停与转速
├── libs/                  # 通用工具库文件夹
│   ├── __init__.py         # 库包导出
│   └── scheduler.py        # 任务调度器库，实现多任务周期管理、异常回调
└── tasks/                 # 任务逻辑文件夹，与硬件驱动解耦
    ├── __init__.py         # 任务包导出
    └── sensor_task.py      # 核心任务模块，定义 SensorMotorTask 类，实现感应控制逻辑
```
## 文件说明（File Description）

### 1. 启动与入口模块
- `boot.py`：系统启动脚本，上电后初始化板载LED，绿色闪烁3次提示启动完成；  
- `main.py`：项目核心入口，逻辑包括：  
  1. 延时2秒等待硬件稳定，通过`board.py`获取引脚配置；  
  2. 初始化PIR传感器、MOS管驱动、按键、LED等硬件，失败则调用`fatal_hang`闪灯报错；  
  3. 创建`SensorMotorTask`实例（传入驱动对象与配置参数）；  
  4. 初始化调度器（周期10ms），添加核心任务与维护任务（自动GC）；  
  5. 注册按键中断回调（任务暂停/恢复），启动调度器进入循环。  


### 2. 硬件驱动
#### PIR传感器驱动（pir_driver.py）
- **核心类**：`PIRSensor(pin)`  
- **关键方法**：  
  - `is_detected()`：返回是否检测到人体（已过200ms防抖处理）；  
  - `get_status()`：返回传感器工作状态（正常/未连接），用于故障检测。  


#### MOS管电机驱动（opto_mos_driver.py）
- **核心类**：`OptoMosDriver(pwm_pin)`  
- **关键方法**：  
  - `start(speed=100)`：启动电机，速度0-100可调（PWM占空比）；  
  - `stop()`：停止电机运行；  
  - `is_connected()`：检测驱动模块是否正常连接。  


### 3. 任务逻辑（sensor_task.py）
- **核心类**：`SensorMotorTask`，实现“感应-判断-执行”逻辑：  
  - `__init__`：初始化硬件实例、配置参数（运行时间、锁定期）、状态标记（`is_running`、`is_locked`）；  
  - `tick`：每10ms执行一次，流程为“检测任务状态→读取PIR信号→判断是否触发→控制电机启停→更新LED显示”；  
  - `toggle_pause`：切换任务暂停/恢复状态，暂停时关闭传感器检测；  
  - `_handle_lock`：管理锁定期，避免短时间内重复触发电机。  


### 4. 配置与工具
- `board.py`：定义`BOARDS`字典，包含GraftPort-RP2040的PIR、电机、按键等引脚映射，提供`get_pin`接口；  
- `conf.py`：可配置参数，如`MOTOR_RUN_TIME_MS`（电机运行时间，默认5000ms）、`LOCK_DELAY_MS`（锁定期，默认3000ms）、`ENABLE_DEBUG`（调试开关）；  
- `libs/scheduler.py`：`Scheduler`类支持任务周期调度、异常捕获，绑定空闲回调（触发GC）。  


## 软件设计核心思想（Design Idea）
### 1. 分层解耦架构
- **驱动层（drivers/）**：专注硬件底层控制（如PIR信号读取、电机PWM输出），与业务逻辑隔离，更换硬件仅需修改驱动；  
- **任务层（tasks/）**：基于驱动接口实现业务流程，`SensorMotorTask`封装“感应-控制”逻辑，不依赖具体引脚；  
- **调度层（libs/scheduler.py）**：提供通用任务管理，支持多任务并行、周期调度，适配复杂场景扩展；  
- **配置层（board.py/conf.py）**：抽象硬件差异与运行参数，使核心代码可跨板复用、参数可灵活调整。  


### 2. 状态机管理
- 系统定义4种核心状态：`STANDBY`（待机，等待感应）、`TRIGGERED`（触发，启动电机）、`RUNNING`（运行，电机工作中）、`LOCKED`（锁定，防止重复触发）；  
- 状态转换通过事件触发（PIR检测→STANDBY→TRIGGERED→RUNNING→超时→LOCKED→超时→STANDBY），逻辑清晰可追溯。  


### 3. 容错与防误触设计 
- 感应防抖：PIR信号需连续200ms有效才判定为“检测到人体”，过滤瞬时干扰；  
- 锁定期机制：电机停止后进入3秒锁定，避免人体未离开时重复触发，减少电机损耗。  


## 使用说明（Quick Start）
### 1. 硬件连接
按“硬件要求”中的连接方式，将PIR传感器、MOS管驱动、电机等模块与GraftPort-RP2040连接，确保供电稳定（传感器5V，电机按需接12V以下电源）。

## 示例程序（Example）
- 本项目无其他示例程序。
## 注意事项（Notes）
### 硬件相关：
- PIR 传感器需避免正对热源（如灯光、暖气）或强气流，否则易误触发；
- 电机电源需与主控电源共地，否则可能导致控制信号异常；
- MOS 管驱动需根据电机功率选择合适型号，避免过载损坏。
### 软件相关：
- 电机运行时间不宜过长（>10 秒），可能导致泡泡液消耗过快；
- 锁定期不宜过短（<2 秒），可能造成电机频繁启停；
- 调试模式（ENABLE_DEBUG=True）会输出详细日志，正式使用时建议关闭以节省资源。
## 版本记录（Version History）
v1.0.0：缪贵成完成初始版本
- 实现 PIR 人体感应与泡泡机电机自动控制；
- 支持运行时间、锁定期配置；
- 适配板载按键暂停 / 恢复与 LED 状态指示；
- 集成任务调度与错误处理机制。
## 联系开发者（Contact）
如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 **邮箱**：10696531183@qq.com  
💻 **GitHub**：[https://github.com/FreakStudioCN](https://github.com/FreakStudioCN)  

## 许可协议（License）

本项目中，除 `machine` 等 MicroPython 官方模块（MIT 许可证）外，所有由作者编写的驱动与扩展代码均采用 **知识共享署名-非商业性使用 4.0 国际版 (CC BY-NC 4.0)** 许可协议发布。  

您可以自由地：  
- **共享** — 在任何媒介以任何形式复制、发行本作品  
- **演绎** — 修改、转换或以本作品为基础进行创作  

惟须遵守下列条件：  
- **署名** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否（对原始作品）作了修改。您可以用任何合理的方式来署名，但是不得以任何方式暗示许可人为您或您的使用背书。  
- **非商业性使用** — 您不得将本作品用于商业目的。  
- **合理引用方式** — 可在代码注释、文档、演示视频或项目说明中明确来源。  

**版权归 FreakStudio 所有。**
