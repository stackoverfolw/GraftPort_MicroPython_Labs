# 滑动变阻器调节直流电机转速控制系统

## 目录
- [简介（Description）](#简介description)
- [主要功能（Features）](#主要功能features)
- [硬件要求（Hardware Requirements）](#硬件要求hardware-requirements)
- [软件环境（Software Environment）](#软件环境software-environment)
- [文件结构（File Structure）](#文件结构file-structure)
- [文件说明（File Description）](#文件说明file-description)
- [软件设计核心思想（Design Idea）](#软件设计核心思想design-idea)
- [使用说明（Quick Start）](#使用说明quick-start)
- [示例程序（Example）](#示例程序example)
- [注意事项（Notes）](#注意事项notes)
- [版本记录（Version History）](#版本记录version-history)
- [联系开发者（Contact）](#联系开发者contact)
- [许可协议（License）](#许可协议license)


## 简介（Description）
### 项目背景
传统直流电机调速多依赖固定档位开关或专用调速器，存在调节精度低、状态反馈缺失等问题，难以满足教学演示、DIY制作等场景对“实时连续调节”的需求。本项目基于GraftPort-RP2040开发板，整合滑动变阻器（电位器）、PCA9685电机驱动与OLED显示屏，通过MicroPython实现“阻值采集→转速转换→实时显示”的直接控制流程，解决传统方案中“调节滞后、状态不直观”的痛点。

### 项目主要功能概览
本项目核心功能是通过滑动变阻器（电位器）实时采集阻值变化（0-10kΩ），经ADC转换为0-100%的转速比例，通过PCA9685驱动模块输出PWM信号控制直流电机转速；同时在OLED屏幕上显示当前阻值、PWM占空比及电机转速（百分比），支持板载按键切换电机启停状态，适配电子教学、小型机械控制等场景。

### 适用场景或应用领域
- 教学演示：中小学电子实验中“欧姆定律、PWM调速、模数转换”等知识点的实践；  
- DIY制作：小型机器人、风扇、传送带等设备的手动无级调速模块；  
- 创客项目：作为基础控制单元，快速验证手动调速逻辑的原型系统。  


## 主要功能（Features）
- **实时阻值采集**：滑动变阻器（电位器）通过ADC接口每秒采集10次阻值（0-10kΩ），直接读取原始值无滤波处理，确保调节实时性；  
- **无级调速控制**：阻值与电机转速（0-100%）线性映射，通过PCA9685输出12位PWM信号（精度4096级），实现平滑连续调速；  
- **状态可视化反馈**：SSD1306 OLED屏幕实时显示“当前阻值（kΩ）、PWM占空比（%）、电机状态（运行/停止）”，数据每秒刷新2次；  
- **交互控制**：板载按键支持电机“运行/停止”一键切换，切换时有LED状态指示（运行=绿灯亮，停止=红灯亮）；  
- **异常保护**：电机堵转或驱动模块连接异常时，自动停止输出并在OLED显示错误提示，避免硬件损坏；  
- **参数可配置**：通过`conf.py`调整阻值-转速映射范围（如0-5kΩ对应0-100%转速）、显示刷新频率等参数。  


## 硬件要求（Hardware Requirements）
项目基于GraftPort-RP2040开发板作为主控：  

**所需模块清单**：  
- 调节模块：10kΩ滑动变阻器（电位器，3引脚）；  
- 执行模块：6-12V直流电机 + PCA9685 PWM驱动板（I2C通信）；  
- 显示模块：SSD1306 OLED屏幕（128x64分辨率，I2C通信，地址0x3C）；  
- 交互模块：板载按键（1路，启停控制）、板载LED（2路，红绿双色状态指示）；  
- 供电模块：5V直流电源（为主控、传感器、OLED供电）+ 12V电源（为电机供电，需与5V电源共地）。  

**连接方式**：  
1. 滑动变阻器：VCC接3.3V、GND接GND、信号端接ADC引脚（参考`board.py`配置）；  
2. PCA9685驱动板：VCC接5V、GND接GND、SDA接I2C-SDA引脚、SCL接I2C-SCL引脚，电机连接至通道0；  
3. OLED屏幕：VCC接3.3V、GND接GND、SDA接I2C-SDA引脚、SCL接I2C-SCL引脚（与PCA9685共用I2C总线）；  
4. 板载按键：一端接GPIO引脚（上拉输入）、另一端接GND；  
5. 状态LED：绿灯接GPIO1、红灯接GPIO2（均串联1K限流电阻）。  


## 软件环境（Software Environment）
- 核心固件：MicroPython v1.23.0（适配GraftPort-RP2040，支持`machine.ADC/I2C/PWM/Pin`模块）；  
- 开发IDE：Thonny（支持MicroPython实时调试，适合查看ADC实时数据）；  
- 辅助工具：  
  - mpremote v0.11.0+（命令行文件传输与串口交互）；  
  - Python 3.10+（运行阻值-转速映射校准脚本）；  
- 依赖模块：无第三方库，PCA9685、SSD1306、电位器驱动均为项目自定义实现。  


## 文件结构（File Structure）
```

firmware/
├── board.py               # 板级支持文件，定义 GraftPort-RP2040 的引脚映射（ADC/I2C/GPIO）
├── conf.py                # 配置文件，存放可自定义参数（映射范围、刷新频率等）
├── main.py                # 项目入口文件，负责硬件初始化、任务创建与调度启动
├── boot.py                # 启动脚本，初始化板载 LED，提示系统启动状态
├── drivers/               # 硬件驱动文件夹，封装各外设控制接口
│   ├── __init__.py         # 驱动包导出，简化外部调用
│   ├── bus_dc_motor_driver/  # PCA9685 电机驱动，提供 PWM 调速与启停控制
│   ├── potentiometer_driver/ # 滑动变阻器驱动，实现 ADC 阻值采集
│   └── ssd1306_driver/       # SSD1306 OLED 驱动，提供状态显示方法
├── libs/                  # 通用工具库文件夹
│   ├── __init__.py         # 库包导出
│   └── scheduler.py        # 任务调度器库，实现多任务周期管理（采集 / 控制 / 显示）
└── tasks/                 # 任务逻辑文件夹，与硬件驱动解耦
    ├── __init__.py         # 任务包导出
    └── sensor_task.py      # 核心任务模块，定义 SensorPotMotorTask 类，实现调节逻辑

```
## 文件说明（File Description）

### 1. 启动与入口模块
- `boot.py`：系统启动脚本，上电后初始化板载LED（红绿交替闪烁3次），提示硬件启动完成；  
- `main.py`：项目核心入口，逻辑包括：  
  1. 延时1秒等待硬件稳定，通过`board.py`获取引脚配置（ADC、I2C、按键等）；  
  2. 初始化滑动变阻器（ADC）、PCA9685电机驱动、OLED屏幕、按键、LED等硬件；  
  3. 创建`SensorPotMotorTask`实例（传入驱动对象与配置参数），封装为调度任务（周期100ms）；  
  4. 初始化调度器（软定时器，周期50ms），添加核心任务与GC维护任务；  
  5. 注册按键中断回调（电机启停切换），启动调度器进入循环。  


### 2. 硬件驱动
#### 滑动变阻器驱动（potentiometer_driver/）
- **核心类**：`Potentiometer(adc_pin, max_resistance=10)`（max_resistance单位：kΩ）  
- **关键方法**：  
  - `get_resistance()`：返回当前阻值（kΩ，保留2位小数），直接读取ADC原始值转换，无滤波；  
  - `get_percentage()`：返回阻值占最大阻值的比例（0-100%），用于映射转速。  


#### 直流电机驱动（bus_dc_motor_driver/）
- **核心类**：`BusDCMotor(i2c, address=0x40, channel=0)`  
- **关键方法**：  
  - `set_speed(percentage)`：设置电机转速（0-100%，自动转换为PCA9685的12位PWM值）；  
  - `stop()`：立即停止电机（PWM占空比设为0）；  
  - `is_connected()`：检测PCA9685驱动板是否正常连接（通过I2C地址扫描）。  


#### OLED驱动（ssd1306_driver/）
- **核心类**：`SSD1306OLED(i2c, addr=0x3C)`  
- **关键方法**：  
  - `display_status(resistance, duty_cycle, is_running)`：显示阻值（kΩ）、PWM占空比（%）、电机状态；  
  - `display_error(message)`：显示错误信息（如“驱动连接失败”）；  
  - `clear()`：清屏并刷新显示。  


### 3. 任务逻辑（sensor_task.py）
- **核心类**：`SensorPotMotorTask`，实现“采集-转换-控制-显示”闭环逻辑：  
  - `__init__`：初始化硬件实例、配置参数（映射范围）、状态标记（`is_running`）；  
  - `tick`：每100ms执行一次，流程为“读取变阻器阻值→转换为转速比例→根据运行状态控制电机→更新OLED与LED显示”；  
  - `toggle_running`：切换电机运行/停止状态（按键触发），停止时将转速置0；  
  - `_map_resistance_to_speed`：根据`conf.py`配置的映射范围，将阻值比例线性转换为目标转速。  


### 4. 配置与工具
- `board.py`：定义`PIN_CONFIG`字典，包含ADC引脚（如`ADC0`）、I2C引脚（`SDA=2, SCL=3`）、按键/LED引脚映射；  
- `conf.py`：可配置参数，如`RESISTANCE_RANGE=(0, 10)`（阻值映射范围，单位kΩ）、`REFRESH_RATE_HZ=2`（显示刷新频率）；  
- `libs/scheduler.py`：`Scheduler`类支持多任务并行调度，确保采集（100ms）、显示（500ms）等任务按周期执行，避免阻塞。  


## 软件设计核心思想（Design Idea）
### 1. 分层解耦架构
- **驱动层（drivers/）**：专注硬件底层操作（如ADC读取、I2C通信、PWM输出），对外提供统一接口（`get_resistance()`/`set_speed()`），更换硬件时仅需修改驱动；  
- **任务层（tasks/）**：基于驱动接口实现业务逻辑，`SensorPotMotorTask`封装“阻值→转速→控制”的核心流程，不依赖具体引脚或硬件型号；  
- **调度层（libs/scheduler.py）**：抽象任务周期管理，支持不同频率的任务并行执行（如高频采集、低频显示），提升系统响应效率；  
- **配置层（board.py/conf.py）**：隔离硬件差异与运行参数，通过修改配置即可适配不同规格的变阻器（如5kΩ）或电机。  


### 2. 实时调节优先
- 无滤波设计：直接读取滑动变阻器的ADC值并转换为转速，确保调节动作与电机响应无延迟，适合需要快速反馈的场景；  
- 线性映射：阻值与转速呈1:1线性关系（如10%阻值对应10%转速），调节逻辑直观，便于教学演示中理解“输入与输出”的对应关系；  
- 轻量化处理：采集与控制逻辑简化，避免复杂计算占用系统资源，确保100ms周期内完成一次闭环控制。  


### 3. 状态安全管理
- 电机状态与任务绑定：`is_running`标记控制所有转速输出，停止状态下无论阻值如何变化，电机均保持静止；  
- 异常快速响应：检测到驱动板断开或电机堵转时，100ms内触发`stop()`并显示错误，避免持续无效输出；  
- 按键防抖处理：按键信号需保持200ms稳定状态才触发切换，防止误触导致的电机频繁启停。  


## 使用说明（Quick Start）
### 1. 硬件连接
按“硬件要求”中的连接方式，将滑动变阻器、PCA9685驱动、电机、OLED等模块与GraftPort-RP2040连接，确保电机电源（12V）与主控电源（5V）共地，避免信号干扰。


## 示例程序（Example）
- 无其他示例程序。
## 注意事项（Notes）
### 硬件相关：
- 滑动变阻器需选择线性型（而非对数型），确保阻值变化与旋转角度成线性关系；
- 电机电源电压需与电机额定电压匹配（如 12V 电机接 12V 电源），电压不足会导致转速偏低；
- I2C 总线上设备地址不可冲突（默认 PCA9685=0x40，OLED=0x3C），如需修改地址需同步更新驱动参数。
### 软件相关：
- 阻值范围配置需与实际变阻器规格一致（如 5kΩ 变阻器需设RESISTANCE_RANGE=(0, 5)），否则会出现转速调节范围异常；
- 频繁快速调节变阻器时，OLED 显示可能存在轻微滞后（受限于刷新频率），属正常现象； 
- 调试时可通过print语句输出 ADC 原始值（0-65535），验证硬件连接是否正常。
## 版本记录（Version History）
v1.0.0：初始版本
- 实现滑动变阻器实时采集与电机无级调速；
- 支持 OLED 状态显示与按键启停控制；
- 集成异常检测与保护功能；
- 适配 GraftPort-RP2040 开发板。

## 联系开发者（Contact）
如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 **邮箱**：10696531183@qq.com  
💻 **GitHub**：[https://github.com/FreakStudioCN](https://github.com/FreakStudioCN)  

## 许可协议（License）

本项目中，除 `machine` 等 MicroPython 官方模块（MIT 许可证）外，所有由作者编写的驱动与扩展代码均采用 **知识共享署名-非商业性使用 4.0 国际版 (CC BY-NC 4.0)** 许可协议发布。  

您可以自由地：  
- **共享** — 在任何媒介以任何形式复制、发行本作品  
- **演绎** — 修改、转换或以本作品为基础进行创作  

惟须遵守下列条件：  
- **署名** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否（对原始作品）作了修改。您可以用任何合理的方式来署名，但是不得以任何方式暗示许可人为您或您的使用背书。  
- **非商业性使用** — 您不得将本作品用于商业目的。  
- **合理引用方式** — 可在代码注释、文档、演示视频或项目说明中明确来源。  

**版权归 FreakStudio 所有。**
