# 传感器触发式街机音效系统

## 目录
- [简介（Description）](#简介description)
- [主要功能（Features）](#主要功能features)
- [硬件要求（Hardware Requirements）](#硬件要求hardware-requirements)
- [软件环境（Software Environment）](#软件环境software-environment)
- [文件结构（File Structure）](#文件结构file-structure)
- [文件说明（File Description）](#文件说明file-description)
- [软件设计核心思想（Design Idea）](#软件设计核心思想design-idea)
- [使用说明（Quick Start）](#使用说明quick-start)
- [示例程序（Example）](#示例程序example)
- [注意事项（Notes）](#注意事项notes)
- [版本记录（Version History）](#版本记录version-history)
- [联系开发者（Contact）](#联系开发者contact)
- [许可协议（License）](#许可协议license)

## 简介（Description）

### 项目背景

传统蜂鸣器多为单一触发方式（如固定按键控制），缺乏环境交互性，且音效输出模式单一。本项目基于GraftPort-RP2040开发板，结合霍尔传感器（磁场检测）与麦克风（声音采集），实现“多源触发-音效联动”控制，解决传统蜂鸣器交互形式有限的问题。同时融入MicroPython轻量化任务调度与异常处理机制，保证系统在嵌入式环境下稳定运行。

### 项目主要功能概览

本项目基于MicroPython开发，核心功能是通过霍尔传感器实时检测磁场变化（如磁铁靠近）、麦克风采集声音信号（如拍手、敲击），经信号滤波与阈值判断后，控制LM386播放预设街机音效（如“投币”“击打”“胜利”等）；支持板载按键中断切换系统启停，内置自动垃圾回收（GC）避免内存泄漏，异常捕获与限速打印便于问题定位，传感器初始化重试机制提升硬件兼容性。

### 适用场景或应用领域

- 互动玩具：儿童电子玩具的触发式音效反馈，如磁铁靠近触发角色语音、拍手触发动作音效；  
- 创意装置：艺术展览、科普展项的互动音效模块，通过磁场或声音触发特定音频反馈；  
- 教学演示：用于MicroPython传感器交互、中断处理、PWM音效生成等知识点的实践教学；  
- 智能家居：简易声光联动系统，如敲门声（麦克风检测）触发提示音、门窗磁吸（霍尔检测）触发警报音效。

## 主要功能（Features）

- **多源信号采集与滤波**：霍尔传感器每10ms采集一次磁场状态（有/无），麦克风每20ms采集一次声音强度（ADC值），采用“连续3次采样确认”机制（避免瞬时干扰），保证触发信号稳定性；  
- **音效联动控制**：根据触发源类型（霍尔/麦克风/按键）映射不同街机音效，支持音效优先级配置（按键触发＞霍尔触发＞麦克风触发），同一触发源可设置多级阈值对应不同音效；  
- **板载按键交互**：板载按键触发下降沿中断，可切换系统“运行/暂停”状态，暂停时立即停止当前音效并清空触发缓冲，避免恢复时信号残留；  
- **自动内存管理**：空闲时检测内存，若低于阈值（默认100000字节）自动触发GC，防止MicroPython因内存碎片导致的运行异常；  
- **异常容错机制**：传感器初始化支持多次重试（次数可配置），失败时板载LED闪灯+终端报错阻塞；任务执行抛异常时，完整打印回溯信息并限速（默认1秒/次），避免串口刷屏；  
- **板级适配灵活**：基于board.py实现引脚映射解耦，支持后续扩展其他RP2040开发板，核心业务逻辑无需修改。

## 硬件要求（Hardware Requirements）

项目基于GraftPort-RP2040开发板作为主控：

**其余需要的模块包括：**
- GraftSense-霍尔传感器模块（数字输出，高电平表示检测到磁场，默认响应距离≤5mm）；  
- GraftSense-麦克风模块（模拟输出，支持30-1000Hz声音采集，灵敏度可调）；  
- GraftSense-无源蜂鸣器模块（需PWM频率驱动，支持1kHz-8kHz音效输出）；  
- 板载按键：默认使用开发板固定引脚（引脚18，上拉输入），无需额外接线；  
- 板载LED：默认使用开发板固定引脚（引脚25），无需额外接线；  
- 外接5V电源：通过Type-C接口供电（无锂电池充放电模块）。

**连接方式：**

1. **硬件连线**  
   - **霍尔传感器模块**：通过PH2.0-3P连接线接入数字接口；  
   board.get_dio_pins(0)[0]
   - **麦克风模块**：通过PH2.0-3P连接线接入ADC接口；  
   board.get_adc_pins(0)[0]
   - **无源蜂鸣器模块**：通过PH2.0-3P连接线接入PWM接口；  
   board.get_dio_pins(1)[0]

2. **注意事项**  
   - 霍尔传感器需远离强磁场环境，避免误触发；  
   - 麦克风模块需靠近声音源（建议距离≤50cm），确保有效采集；  
   - 无源蜂鸣器正负极需正确连接（VCC接3.3V，GND接开发板地，SIG接PWM引脚）。

## 软件环境（Software Environment）

- 核心固件：MicroPython v1.23.0（需适配GraftPort-RP2040，支持`machine.Pin/PWM/ADC/Timer`模块、软定时器调度）；  
- 开发IDE：PyCharm（用于代码编写、上传、调试，支持MicroPython REPL交互，需安装MicroPython插件）；  
- 辅助工具：  
  - Python 3.12+（用于运行本地辅助脚本，如依赖分析、固件编译，可选）；  
  - mpy-cross v1.23.0（用于将.py文件编译为.mpy，减少开发板内存占用，可选）；  
  - mpremote v0.11.0+（替代Thonny上传文件，支持命令行操作，可选）；  
- 依赖模块：无额外第三方库，所有驱动（`hall_sensor_driver.py`等）均为自定义实现，随项目文件提供。

## 文件结构（File Structure）
```
项目根目录/
├── libs/                       # 通用工具库文件夹
│   └── scheduler/              # 任务调度器库（支持任务添加/暂停/恢复，空闲/异常回调）
├── drivers/                    # 硬件驱动文件夹（封装外设控制接口）
│   ├── hall_sensor_driver.py   # 霍尔传感器驱动（提供`read_state()`方法）
│   ├── max9814_mic_driver.py       # 麦克风驱动（提供`read_volume()` `is_triggered()`方法）
│   └── passive_buzzer_driver.py# 无源蜂鸣器驱动（提供`play_tone()` `stop()`方法）
├── tasks/                      # 任务逻辑文件夹（业务相关实现）
│   ├── sensor_task.py          # 核心任务模块，定义`SensorTriggerTask`类（采集→滤波→触发判断）
│  
├── main.py                     # 项目入口文件（硬件初始化、任务创建、调度器启动）
├── board.py                    # 板级支持文件（GraftPort-RP2040引脚映射）
├── conf.py                     # 配置文件（传感器阈值、重试次数、GC阈值等）
├── README.md                   # 项目说明文档
├── tools/                      # 开发辅助脚本（依赖分析、MPY编译）
└── docs/                       # 文档（引脚表、硬件图、演示图）
    ├── graftport_pinout_table.md   # GraftPort-RP2040引脚映射表
    └── xxx.png                 # 硬件连接、演示效果图片
```
## 文件说明（File Description）

- `main.py`：项目入口，核心逻辑包括：  
  1. 上电延时3秒（等待硬件稳定），初始化板载LED、霍尔传感器、麦克风、按键（含中断注册）；  
  2. 初始化传感器（支持多次重试，失败则调用`fatal_hang`阻塞并闪灯报错）；  
  3. 创建`SensorTriggerTask`（传感器采集，周期20ms）与`BuzzerSoundTask`（音效播放，周期50ms）实例，封装为调度器任务；  
  4. 初始化`Scheduler`（软定时器，调度周期10ms），添加任务并启动调度，进入无限循环；  
  5. 定义`button_handler`中断回调（切换系统启停）、`fatal_hang`阻塞函数（严重错误处理）。

- `drivers/`：硬件驱动模块，均采用“实例化+方法调用”模式：  
  - `hall_sensor_driver.py`：`HallSensor`类通过`Pin`读取数字信号，`read_state()`返回磁场状态（1=检测到，0=未检测到）；  
  - `max9814_mic_driver.py`：`MAX9814Mic`类通过`ADC`采集模拟信号，`read_volume()`返回原始值 ;
  - `passive_buzzer_driver.py`：`Buzzer`类通过`PWM`输出信号，`play_tone(freq, duration)`控制频率与播放时长，`stop()`终止播放。

- `tasks/`：业务任务模块：  
  - `sensor_task.py`：`SensorAudioTask`类关键逻辑：  
    - `__init__`：初始化传感器实例、滤波缓冲（连续3次采样）、触发阈值；  
    - `tick`：每20ms执行一次，流程为“采集传感器数据→连续采样确认→播放”；

- `board.py`：板级引脚映射模块，定义`BOARDS`字典（含GraftPort-RP2040的引脚映射），提供`get_pin`接口，实现“板级配置与业务逻辑解耦”。

- `conf.py`：用户配置文件，可自定义参数包括：`SENSOR_INIT_MAX_ATTEMPTS`（传感器初始化重试次数）、`HALL_TRIGGER_THRESHOLD`（霍尔连续检测次数）、`MIC_VOLUME_THRESHOLD`（麦克风触发阈值）、`ENABLE_DEBUG`（调试打印开关）等，无定义时使用默认值。

## 软件设计核心思想（Design Idea）


### 1. 系统分层思路：采用“四层架构”，实现解耦与复用
- 硬件驱动层（drivers/）：仅负责硬件的底层控制，如麦克风驱动只关心“如何读取声音值”，不关心“何时判断触发”；  
- 任务逻辑层（tasks/）：基于驱动层接口实现业务逻辑，如`SensorTriggerTask`调用`read_volume()`但不关心麦克风的ADC引脚编号；  
- 调度控制层（libs/scheduler.py）：提供通用任务管理能力，支持任务周期调度、暂停/恢复、异常处理，不依赖具体业务；  
- 入口层（main.py）：负责“组装”各层，初始化硬件→创建任务→启动调度，是系统的“胶水”，不包含核心业务逻辑。

### 2. 核心机制：保障系统稳定与交互体验
- 任务调度机制：基于软定时器实现多任务并行，传感器采集（高频20ms）与音效播放（低频50ms）分离，避免相互阻塞；  
- 信号滤波机制：采用“连续采样确认”（如霍尔需连续3次检测到磁场才触发），过滤瞬时干扰（如磁铁快速掠过）；  
- 交互反馈机制：按键中断“即时响应”，暂停时立即停止音效；传感器初始化失败时“明确报错”（闪灯+终端信息），便于定位硬件问题；  
- 容错机制：所有硬件操作均用`try-except`包裹，单一模块故障（如麦克风读取失败）不影响其他模块（如霍尔+蜂鸣器仍可工作）。

## 使用说明（Quick Start）

### 1. 硬件连接
按“硬件要求”中的连接方式，连接主控板、传感器模块和电源；  

### 2. 运行项目（使用PyCharm + MicroPython插件）
1. 打开PyCharm并安装MicroPython插件；  
2. 在插件中选择目标设备为`GraftPort-RP2040`，启用自动检测设备路径；  
3. 将项目根目录设置为固件目录；  
4. 修改运行配置，勾选“允许多个实例”，保存后点击运行按钮上传固件。

### 3. 配置修改
在`conf.py`中调整参数，例如：# conf.py 示例配置
SENSOR_INIT_MAX_ATTEMPTS = 3      # 传感器初始化最多重试3次
HALL_TRIGGER_THRESHOLD = 3        # 霍尔需连续3次检测到磁场才触发
MIC_VOLUME_THRESHOLD = 2000       # 麦克风声音值≥2000时触发
ENABLE_DEBUG = True               # 开启调试打印（查看传感器数据）
### 4. 功能测试
- **霍尔触发**：将磁铁靠近霍尔传感器（距离≤5mm），蜂鸣器播放“解锁”音效；  
- **声音触发**：在麦克风附近拍手（声音足够大），蜂鸣器播放“击打”音效；  
- **按键控制**：按下板载按键，系统暂停（蜂鸣器停止）；再次按下，系统恢复；  
- **调试查看**：开启`ENABLE_DEBUG`后，终端会输出传感器数据（如“hall:1 mic:2500 trigger:hall”）。

## 示例程序（Example）

本项目没有其余参考示例代码，直接在firmware文件夹中进行修改即可。

## 注意事项（Notes）

- **传感器相关**：  
  - 霍尔传感器检测距离有限（≤5mm），需确保磁铁与传感器足够接近；  
  - 麦克风模块易受环境噪音影响，建议在`conf.py`中根据实际环境调整`MIC_VOLUME_THRESHOLD`；  
  - 传感器初始化重试次数建议≥3次，避免上电瞬间信号不稳定导致初始化失败。

- **硬件连接相关**：  
  - 无源蜂鸣器需区分正负极，接反会导致无声；  
  - 麦克风模块的模拟信号线需连接ADC引脚（而非普通GPIO），否则无法读取声音值；  
  - 按键采用上拉输入（`Pin.PULL_UP`），按下时引脚电平为低，若无响应需检查引脚定义是否正确。

- **软件版本相关**：  
  - 必须使用MicroPython v1.23.0及以上版本，低版本可能不支持软定时器调度或`machine.ADC`的部分方法；  
  - 调试打印（`ENABLE_DEBUG=True`）会占用内存与串口带宽，正式使用时建议关闭。

## 版本记录（Version History）
- **v1.0.0 (2025-10-16)**：缪贵成完成初始版本，实现核心功能：  
  - 支持霍尔传感器、麦克风、板载按键三种触发方式；  
  - 内置8种街机风格音效，支持触发优先级配置；  
  - 实现传感器数据滤波、自动GC、异常容错机制；  
  - 适配GraftPort-RP2040开发板，提供完整驱动与任务代码。

## 联系开发者（Contact）
如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 **邮箱**：10696531183@qq.com  
💻 **GitHub**：[https://github.com/FreakStudioCN](https://github.com/FreakStudioCN)  

## 许可协议（License）

本项目中，除 `machine` 等 MicroPython 官方模块（MIT 许可证）外，所有由作者编写的驱动与扩展代码均采用 **知识共享署名-非商业性使用 4.0 国际版 (CC BY-NC 4.0)** 许可协议发布。  

您可以自由地：  
- **共享** — 在任何媒介以任何形式复制、发行本作品  
- **演绎** — 修改、转换或以本作品为基础进行创作  

惟须遵守下列条件：  
- **署名** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否（对原始作品）作了修改。您可以用任何合理的方式来署名，但是不得以任何方式暗示许可人为您或您的使用背书。  
- **非商业性使用** — 您不得将本作品用于商业目的。  
- **合理引用方式** — 可在代码注释、文档、演示视频或项目说明中明确来源。  

**版权归 FreakStudio 所有。**

    