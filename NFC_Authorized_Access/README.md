# NFC门禁控制系统

## 目录
- [简介（Description）](#简介description)
- [主要功能（Features）](#主要功能features)
- [硬件要求（Hardware Requirements）](#硬件要求hardware-requirements)
- [软件环境（Software Environment）](#软件环境software-environment)
- [文件结构（File Structure）](#文件结构file-structure)
- [文件说明（File Description）](#文件说明file-description)
- [软件设计核心思想（Design Idea）](#软件设计核心思想design-idea)
- [使用说明（Quick Start）](#使用说明quick-start)
- [示例程序（Example）](#示例程序example)
- [注意事项（Notes）](#注意事项notes)
- [版本记录（Version History）](#版本记录version-history)
- [联系开发者（Contact）](#联系开发者contact)
- [许可协议（License）](#许可协议license)


## 简介（Description）
### 项目背景
传统门禁系统多依赖机械钥匙或密码输入，存在易丢失、易泄露、授权管理复杂等问题。本项目基于GraftPort-RP2040开发板，整合PN532 NFC模块（非接触式卡片识别）与步进电机驱动（门锁执行机构），实现“NFC卡片授权-身份验证-电机驱动开锁”的自动化流程，解决传统门禁的安全性与便捷性矛盾。同时融入轻量化任务调度与状态机管理，确保嵌入式场景下的稳定运行。

### 项目主要功能概览
本项目基于MicroPython开发，核心功能是通过PN532模块读取NFC卡片UID，与预配置的授权列表比对；验证通过后，控制步进电机旋转指定角度（模拟开锁），并在设定时间后自动复位（模拟关锁）；支持OLED屏幕显示门禁状态（可选）、板载按键暂停/恢复任务，内置错误处理机制（硬件故障时LED报警），适配小型办公、家庭等场景的门禁管理需求。

### 适用场景或应用领域
- 小型办公场所：替代传统钥匙，通过NFC卡片实现员工门禁授权，便于人员变动时快速更新权限；  
- 家庭安防：为家人或访客配置临时NFC卡片，避免密码泄露风险，支持随时注销授权；  
- 教学演示：用于嵌入式课程中“RFID通信、电机控制、任务调度”等知识点的实践教学；  
- 创客项目：作为轻量化门禁模块，快速集成到智能柜体、无人值守设备等DIY作品中。


## 主要功能（Features）
- **NFC身份识别**：PN532模块支持ISO14443A协议（兼容Mifare Classic等常见NFC卡片），每100ms扫描一次卡片，读取UID速度≤200ms；  
- **授权管理机制**：内置`AUTHORIZED_UIDS`列表，支持添加/删除卡片UID（十六进制字符串格式），验证通过后触发开锁动作；  
- **步进电机精准控制**：基于PCA9685驱动步进电机，实现90度正转（开锁）与反转（关锁），角度误差≤1度，支持速度调节（默认500ms/圈）；  
- **状态自动管理**：开锁后保持指定时间（默认5秒）自动关锁，期间重复刷卡无效（防误操作），支持通过按键强制关锁；  
- **可视化状态反馈**：可选配OLED屏幕显示“待机/验证中/已开锁/未授权”等状态，板载LED同步指示（待机绿灯、开锁红灯、错误闪烁）；  
- **任务中断控制**：板载按键触发下降沿中断，短按切换任务“运行/暂停”，暂停时关闭卡片扫描与电机驱动；  
- **多板级适配**：通过`board.py`定义引脚映射，默认适配GraftPort-RP2040，扩展其他RP2040板型仅需添加配置。


## 硬件要求（Hardware Requirements）

**所需模块清单**：  
- NFC模块：PN532（UART接口通信，默认波特率115200）；  
- 步进电机及驱动：42步进电机 + PCA9685 PWM驱动板（I2C通信，默认地址0x40）；  
- 显示模块（可选）：SSD1306 OLED屏幕（I2C通信，128x64分辨率）；  
- 状态指示：板载LED（至少1路，用于状态提示）；  
- 交互模块：板载按键（1路，用于任务控制）；  
- 供电模块：SY7656锂电池充放电模块（输出3.3V，为主控及模块供电）。  

**连接方式**：  
1. PN532模块：VCC接3.3V、GND接GND、TX接UART-RX引脚（参考`board.py`配置）、RX接UART-TX引脚；  
2. PCA9685驱动板：VCC接3.3V、GND接GND、SDA接I2C-SDA引脚、SCL接I2C-SCL引脚；  
3. OLED屏幕（可选）：VCC接3.3V、GND接GND、SDA接I2C-SDA引脚、SCL接I2C-SCL引脚；  
4. 按键：一端接GPIO引脚（上拉输入）、另一端接GND；  
5. 步进电机：A+、A-、B+、B-分别连接PCA9685的对应输出端。  


## 软件环境（Software Environment）
- 核心固件：MicroPython v1.23.0（需适配GraftPort-RP2040，支持`machine.UART/I2C/Pin/Timer`模块）；  
- 开发IDE：PyCharm（安装MicroPython插件，支持代码上传、REPL调试交互）；  
- 辅助工具：  
  - mpremote v0.11.0+（用于命令行式文件传输与设备交互）；  
  - Python 3.10+（运行本地辅助脚本，如卡片UID读取工具）；  
- 依赖模块：无第三方库，PN532、PCA9685等驱动均为项目自定义实现。  


## 文件结构（File Structure）
```
firmware/
├── board.py               # 板级支持文件，定义 GraftPort-RP2040 的引脚映射
├── conf.py                # 配置文件，存放可自定义参数（调试开关、自动启动等）
├── main.py                # 项目入口文件，负责硬件初始化、任务创建与调度启动
├── drivers/               # 硬件驱动文件夹，封装各外设的控制接口
│   ├── bus_step_motor_driver/  # 步进电机驱动，含 PCA9685 与 BusStepMotor 类
│   └── pn532_driver/           # PN532 NFC 模块驱动，提供 UID 读取与初始化方法
├── libs/                  # 通用工具库文件夹
│   └── scheduler.py        # 任务调度器库，实现多任务周期管理、空闲 / 异常回调
└── tasks/                 # 任务逻辑文件夹，与硬件驱动解耦
    ├── __init__.py         # 任务包导出
    ├── maintenance.py      # 维护任务模块，提供自动 GC、错误处理函数
    └── sensor_task.py      # 核心任务模块，定义 NFCDoorTask 类，实现门禁逻辑

```
## 文件说明（File Description）

### 1. 板级配置（board.py）
- **核心功能**：定义开发板引脚映射与硬件接口参数，实现“板级差异与业务逻辑解耦”。  
- **主要特性**：  
  - 内置`BOARDS`字典，包含`graftport_rp2040`的UART（PN532）、I2C（PCA9685/OLED）、按键、LED等引脚映射；  
  - 提供`get_uart_pins()`、`get_i2c_pins()`、`get_fixed_pin()`等方法，统一获取硬件接口引脚；  
  - 支持通过`set_active_board()`切换板型，新增板型只需扩展`BOARDS`字典。  


### 2. 硬件驱动
#### PN532 NFC模块驱动（pn532_driver/）
- **核心功能**：封装PN532的UART通信与卡片UID读取逻辑。  
- **关键方法**：  
  - `__init__(uart)`：初始化UART连接，发送唤醒命令，验证模块是否在线；  
  - `read_uid()`：等待并读取NFC卡片UID，返回十六进制字符串（如`"01:23:45:67"`），超时返回`None`；  
  - `reset()`：重置模块，恢复初始状态（用于通信异常后重试）。  


#### 步进电机驱动（bus_step_motor_driver/）
- **核心功能**：通过PCA9685驱动步进电机，实现精准角度控制。  
- **关键类与方法**：  
  - `PCA9685(i2c)`：初始化PWM驱动板，提供`set_pwm()`方法控制通道输出；  
  - `BusStepMotor(pca, channels)`：绑定电机与驱动通道，`rotate(angle)`方法实现指定角度旋转（正角开锁、负角关锁）；  
  - `set_speed(speed)`：调节电机转速（单位：ms/圈），默认500ms。  


### 3. 任务逻辑（sensor_task.py）
- **核心功能**：实现“读卡-验证-开锁-关锁”的完整门禁流程，封装为`NFCDoorTask`类。  
- **关键方法**：  
  - `__init__`：初始化硬件驱动实例、授权列表、状态标记（`is_locked`、`is_paused`）；  
  - `tick`：每100ms执行一次，流程为“检测任务状态→读取卡片UID→验证授权→控制电机动作→更新状态显示”；  
  - `toggle_pause`：切换任务暂停/运行状态，暂停时关闭卡片扫描；  
  - `_auto_lock`：开锁后启动定时器，到达设定时间（默认5秒）自动关锁。  


### 4. 项目入口（main.py）
- **核心逻辑**：  
  1. 上电延时2秒等待硬件稳定，通过`board.py`初始化UART、I2C、按键、LED引脚；  
  2. 初始化PN532、PCA9685、步进电机（及可选OLED），失败则调用`fatal_hang`闪灯报错；  
  3. 配置授权UID列表（`AUTHORIZED_UIDS`），创建`NFCDoorTask`实例；  
  4. 初始化调度器（周期10ms），添加核心任务与维护任务（自动GC、错误处理）；  
  5. 注册按键中断回调，实现任务暂停/恢复控制，启动调度器进入循环。  


### 5. 配置与维护
- `conf.py`：可自定义参数，如`ENABLE_DEBUG`（调试打印开关）、`AUTO_LOCK_DELAY_S`（自动关锁延时）、`SCAN_INTERVAL_MS`（读卡间隔）；  
- `maintenance.py`：提供`task_idle_callback`（调度空闲时触发GC）和`task_err_callback`（捕获任务异常并打印）。  


## 软件设计核心思想（Design Idea）
### 1. 分层架构设计
- **驱动层（drivers/）**：仅负责硬件底层控制，与业务逻辑解耦（如PN532驱动只关心“如何读UID”，不关心“UID用于什么”）；  
- **任务层（tasks/）**：基于驱动接口实现业务流程，`NFCDoorTask`封装门禁逻辑，不依赖具体引脚配置；  
- **调度层（libs/scheduler.py）**：提供通用任务管理，支持周期调度、暂停/恢复、异常回调，适配多场景需求；  
- **入口层（main.py）**：负责模块组装，初始化硬件→创建任务→启动调度，简化系统搭建流程。  


### 2. 状态机管理
- 系统定义4种核心状态：`STANDBY`（待机，等待刷卡）、`VERIFYING`（验证中，读取UID）、`UNLOCKED`（已开锁，等待自动关锁）、`PAUSED`（暂停，停止扫描）；  
- 状态转换通过事件触发（如刷卡→验证→开锁→超时→待机），避免逻辑混乱，便于调试与扩展。  


### 3. 容错与可靠性设计
- 硬件初始化重试机制：PN532或PCA9685初始化失败时，最多重试3次，仍失败则报错；  
- 通信异常处理：NFC读取超时或数据校验失败时，自动重置模块并继续扫描，不阻断主流程；  
- 防误操作机制：开锁状态下重复刷卡无效，避免电机频繁动作；按键暂停时屏蔽所有操作，确保维护安全。  


## 使用说明（Quick Start）
### 1. 硬件连接
按“硬件要求”中的连接方式，将PN532、PCA9685、步进电机等模块与GraftPort-RP2040连接，确保供电稳定（3.3V）。

### 2. 配置授权卡片
1. 用PN532读取工具获取目标卡片的UID（格式为十六进制字符串，如`"A1:B2:C3:D4"`）；  
2. 编辑`main.py`，在`AUTHORIZED_UIDS`列表中添加该UID：  
   ```python
   AUTHORIZED_UIDS = []
   
## 示例程序（Example）
- 本项目无其他示例程序
## 注意事项（Notes）
### 硬件相关：
- PN532 的 UART 波特率必须与驱动一致（默认 115200），否则无法通信；
- 步进电机与 PCA9685 的接线需对应 A、B 相，接反会导致旋转方向错误；
- OLED 屏幕若地址冲突（默认 0x3C），需修改驱动中的DEFAULT_ADDR参数。
### 软件相关：
- 授权 UID 必须严格匹配（区分大小写），格式错误会导致验证失败；
- 自动关锁延时（AUTO_LOCK_DELAY_S）不宜过短（建议≥3 秒），避免人员未通过即关锁；
- 调试模式（ENABLE_DEBUG=True）会输出详细日志，正式使用时建议关闭以节省资源。
## 版本记录（Version History）
v1.0.0：缪贵成完成初始版本
- 实现 PN532 卡片 UID 读取与授权验证；
- 支持步进电机开锁 / 关锁控制及自动关锁；
- 适配 GraftPort-RP2040，提供按键暂停 / 恢复功能；
- 可选 OLED 状态显示与 LED 指示。

## 联系开发者（Contact）
如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 **邮箱**：10696531183@qq.com  
💻 **GitHub**：[https://github.com/FreakStudioCN](https://github.com/FreakStudioCN)  

## 许可协议（License）

本项目中，除 `machine` 等 MicroPython 官方模块（MIT 许可证）外，所有由作者编写的驱动与扩展代码均采用 **知识共享署名-非商业性使用 4.0 国际版 (CC BY-NC 4.0)** 许可协议发布。  

您可以自由地：  
- **共享** — 在任何媒介以任何形式复制、发行本作品  
- **演绎** — 修改、转换或以本作品为基础进行创作  

惟须遵守下列条件：  
- **署名** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否（对原始作品）作了修改。您可以用任何合理的方式来署名，但是不得以任何方式暗示许可人为您或您的使用背书。  
- **非商业性使用** — 您不得将本作品用于商业目的。  
- **合理引用方式** — 可在代码注释、文档、演示视频或项目说明中明确来源。  

**版权归 FreakStudio 所有。**
