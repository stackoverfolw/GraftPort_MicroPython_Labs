# RGB传感触摸交互系统

## 目录
- [简介（Description）](#简介description)
- [主要功能（Features）](#主要功能features)
- [硬件要求（Hardware Requirements）](#硬件要求hardware-requirements)
- [软件环境（Software Environment）](#软件环境software-environment)
- [文件结构（File Structure）](#文件结构file-structure)
- [文件说明（File Description）](#文件说明file-description)
- [软件设计核心思想（Design Idea）](#软件设计核心思想design-idea)
- [使用说明（Quick Start）](#使用说明quick-start)
- [示例程序（Example）](#示例程序example)
- [注意事项（Notes）](#注意事项notes)
- [版本记录（Version History）](#版本记录version-history)
- [联系开发者（Contact）](#联系开发者contact)
- [许可协议（License）](#许可协议license)


## 简介（Description）

### 项目背景
传统颜色检测与按键交互设备多为独立模块，存在集成度低、联动逻辑复杂等问题，难以满足轻量化嵌入式场景的需求。本项目基于GraftPort-RP2040开发板，整合TCS34725 RGB光谱传感器与触摸按键模块，通过MicroPython实现“触摸触发-颜色采集-联动反馈”的一体化控制，解决传统方案中硬件耦合度高、开发周期长的痛点。

### 项目主要功能概览
项目核心是通过触摸按键触发TCS34725传感器采集环境RGB颜色数据，经处理后转换为对应频率信号，通过蜂鸣器输出声音反馈；支持按键中断控制（按下开始采集、松开停止并播放、采集过程中再次按下重置），内置错误处理机制（硬件初始化失败时LED报警），适配教学演示与小型智能设备开发场景。

### 适用场景或应用领域
- 教育实训：用于嵌入式开发课程，演示传感器通信（I2C）、中断处理、任务调度等知识点；  
- 智能交互设备：如颜色识别玩具（按颜色发出不同声音）、简易色卡检测工具；  
- 创客项目：作为轻量化颜色-声音联动模块，快速集成到DIY作品中。


## 主要功能（Features）
- **高精度RGB采集**：TCS34725传感器支持16位RGB+Clear数据采集，可配置积分时间（2.4ms-700ms）和增益（1x/4x/16x/60x），适应不同光照环境；  
- **触摸按键交互**：支持触摸/机械按键输入，内置0-100ms防抖配置，提供按下/松开回调函数，响应灵敏且稳定；  
- **颜色-声音联动**：将采集的RGB数据转换为频率信号（如红色对应高频、蓝色对应低频），通过蜂鸣器实时播放，实现感官联动；  
- **灵活中断控制**：按键按下启动采集、松开停止并播放、采集过程中再次按下可强制重置，操作逻辑直观；  
- **多板级适配**：通过`board.py`支持多开发板引脚映射，默认适配GraftPort-RP2040，扩展其他RP2040板型仅需添加配置；  
- **错误可视化处理**：硬件初始化失败时，板载LED按特定频率闪烁并终端打印错误信息，便于快速定位问题。


## 硬件要求（Hardware Requirements）
项目基于GraftPort-RP2040开发板作为主控：

**所需模块清单**：  
- 传感器模块：TCS34725 RGB光谱传感器（I2C通信，默认地址0x29）；  
- 交互模块：触摸按键模块（或机械按键，支持数字输入）；  
- 输出模块：蜂鸣器模块（支持PWM驱动，可选）或者LM386扬声器；  
- 供电模块：SY7656锂电池充放电模块（输出3.3V，为主控及传感器供电）；  
- 辅助配件：杜邦线、面包板（用于模块连接）。

**连接方式**：  
1. TCS34725传感器：VCC接3.3V、GND接GND、SDA接I2C0-SDA（参考`board.py`配置）、SCL接I2C0-SCL；  
2. 触摸按键：VCC接3.3V、GND接GND、OUT接指定GPIO（默认对应板载按键引脚）；  
3. 蜂鸣器/LM386功放（可选）：VCC接3.3V、GND接GND、IN接PWM输出引脚（由任务逻辑指定）。  


## 软件环境（Software Environment）
- 核心固件：MicroPython v1.23.0及以上（需支持RP2040芯片，包含`machine.I2C/Pin/PWM`模块）；  
- 开发IDE：PyCharm（安装MicroPython插件，支持代码上传、REPL调试）；  
- 辅助工具：  
  - mpremote v0.11.0+（用于命令行式文件传输与设备交互）；  
  - Python 3.10+（运行本地辅助脚本，可选）；  
- 依赖模块：无第三方库，所有驱动与逻辑均为项目自定义实现。


## 文件结构（File Structure）
```
firmware/
├── drivers/                  # 硬件驱动目录（高内聚，仅暴露控制接口）
│   ├── tcs34725_color_driver/  # TCS34725 RGB 传感器驱动
│   │   └── code/
│   │       └── tcs34725_color.py  # 传感器初始化、数据读取、参数配置实现
│   └── button_driver/          # 触摸按键驱动
│       ├── __init__.py         # 驱动包导出（简化外部调用）
│       └── code/
│           └── touchkey.py     # 按键防抖、状态检测、回调注册实现
├── board.py                  # 板级配置文件（引脚映射与多板支持）
├── main.py                   # 错误处理核心（致命错误时 LED 提示与终端打印）
└── tasks/                    # 任务逻辑目录（业务流程与模块联动）
    └── sensor_task.py        # 传感器 - 按键联动控制（采集、转换、输出逻辑）
```


## 文件说明（File Description）

### 1. 板级配置（board.py）
- **核心功能**：定义开发板引脚映射与硬件接口配置，实现“板级差异与业务逻辑解耦”。  
- **主要特性**：  
  - 内置`BOARDS`字典，包含`graftport_rp2040`等板型的固定引脚（如板载LED、按键）、I2C/UART/DIO接口引脚；  
  - 提供`set_active_board()`切换板型、`get_fixed_pin()`获取固定功能引脚、`get_i2c_pins()`获取I2C接口引脚等方法；  
  - 支持动态修改配置，适配新板型仅需添加`BOARDS`子项，无需修改驱动或任务代码。  


### 2. 硬件驱动
#### TCS34725 RGB传感器驱动（tcs34725_color.py）
- **核心功能**：封装TCS34725传感器的I2C通信与数据处理。  
- **关键方法**：  
  - `__init__(i2c)`：初始化I2C连接，校验传感器ID（0x44），失败抛出`ValueError`；  
  - `set_integration_time(time)`：配置积分时间（影响采样精度与速度）；  
  - `set_gain(gain)`：配置增益（适应不同光照强度）；  
  - `read_rgbc()`：读取RGB+Clear原始数据（返回元组`(r, g, b, c)`）；  
  - `calculate_color_temperature(r, g, b)`：将RGB值转换为色温（K）。  
- **限制**：I2C操作非ISR-safe，禁止在中断服务程序（ISR）中调用。  


#### 触摸按键驱动（touchkey.py）
- **核心功能**：处理按键输入信号，实现防抖与状态回调。  
- **关键方法**：  
  - `__init__(pin_num, idle_state=1, debounce_ms=50)`：初始化引脚（输入模式），配置空闲电平（高/低）与防抖时间；  
  - `set_callback(press=None, release=None)`：注册按下/松开回调函数（触发时自动执行）；  
  - `get_state()`：返回当前稳定状态（0/1），已过防抖处理。  
- **实现机制**：通过定时器定时检测引脚电平，连续`debounce_ms`内状态不变则判定为稳定状态。  


### 3. 任务逻辑（sensor_task.py）
- **核心功能**：联动传感器与按键，实现“触摸-采集-播放”完整流程。  
- **主要流程**：  
  1. 按键按下（触发`press_callback`）：启动TCS34725采集，每100ms读取一次RGB数据，转换为频率值存入缓存；  
  2. 按键松开（触发`release_callback`）：停止采集，通过PWM驱动蜂鸣器按缓存的频率序列播放；  
  3. 采集过程中再次按下：清空缓存，停止当前操作，重新等待按下触发。  


### 4. 错误处理（main.py）
- **核心功能**：提供致命错误处理机制，便于硬件故障定位。  
- **关键函数**：  
  - `fatal_hang(led_pin, error_msg, blink_ms=500)`：接收错误信息后，控制`led_pin`按`blink_ms`间隔闪烁，并在终端循环打印错误信息，直至设备重启。  


## 软件设计核心思想（Design Idea）
### 1. 分层架构设计
- **驱动层（drivers/）**：仅负责硬件底层控制，与业务逻辑完全解耦（如TCS34725驱动只关心“如何读数据”，不关心“数据用在哪”）；  
- **配置层（board.py）**：抽象板级差异，使驱动与任务无需硬编码引脚，提升跨板兼容性；  
- **任务层（tasks/）**：基于驱动与配置实现业务逻辑，聚焦“模块如何联动”，便于功能扩展；  
- **保障层（main.py）**：提供全局错误处理，确保系统故障时可观测、可定位。  


### 2. 模块解耦原则
- 驱动模块通过“类实例+接口方法”对外提供服务，内部实现细节对上层透明；  
- 任务逻辑通过调用驱动接口获取数据/控制硬件，不直接操作传感器寄存器或引脚；  
- 板级配置通过函数接口提供引脚信息，避免驱动与任务中出现“引脚魔数”。  


### 3. 容错与稳定性设计
- 传感器初始化校验ID，失败时通过`fatal_hang`报错，避免无效运行；  
- 按键防抖处理，防止机械抖动导致的误触发；  
- I2C操作加try-except捕获异常，避免通信错误导致系统崩溃。  


## 使用说明（Quick Start）
### 1. 硬件连接
按“硬件要求”中的连接方式，将TCS34725传感器、触摸按键、蜂鸣器（可选）与GraftPort-RP2040连接，确保供电电压正确（3.3V）。

### 2. 环境准备
- 安装PyCharm并配置MicroPython插件，选择目标设备为“RP2040”；  
- 通过USB将开发板连接到电脑，确认设备路径（如`/dev/ttyACM0`或`COMx`）。

### 3. 运行项目
1. 将`firmware/`目录下所有文件上传至开发板根目录；  
2. 复位开发板，通过REPL查看启动日志，无错误提示则初始化成功；  
3. 触摸按键：按下时传感器开始采集，松开后蜂鸣器播放颜色对应的频率。


## 示例程序（Example）
本例程无其他实例程序。

## 注意事项（Notes）
- 硬件连接：TCS34725 的 SDA/SCL 必须连接对应 I2C 接口，反接会导致通信失败；
- I2C 操作限制：传感器读写函数不可在中断回调中调用（非 ISR-safe），否则可能引发总线锁死；
- 防抖时间配置：触摸按键防抖时间建议≥20ms，机械按键建议≥50ms，过短易误触发；
- 电源稳定性：传感器对电源噪声敏感，建议供电线路添加 100nF 滤波电容，避免数据波动；
- 板型切换：更换开发板后需先调用board.set_active_board()，否则引脚映射错误会导致硬件异常。
## 版本记录（Version History）
v1.0.0：缪贵成完成初始版本
- 实现 TCS34725 传感器数据采集与参数配置； 
- 完成触摸按键防抖与回调功能；
- 实现 “按键 - 传感器 - 蜂鸣器” 联动任务逻辑； 
- 支持 GraftPort-RP2040 板型，提供错误处理机制。


## 联系开发者（Contact）
如有任何问题或需要帮助，请通过以下方式联系开发者：  
📧 **邮箱**：10696531183@qq.com  
💻 **GitHub**：[https://github.com/FreakStudioCN](https://github.com/FreakStudioCN)  

## 许可协议（License）

本项目中，除 `machine` 等 MicroPython 官方模块（MIT 许可证）外，所有由作者编写的驱动与扩展代码均采用 **知识共享署名-非商业性使用 4.0 国际版 (CC BY-NC 4.0)** 许可协议发布。  

您可以自由地：  
- **共享** — 在任何媒介以任何形式复制、发行本作品  
- **演绎** — 修改、转换或以本作品为基础进行创作  

惟须遵守下列条件：  
- **署名** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否（对原始作品）作了修改。您可以用任何合理的方式来署名，但是不得以任何方式暗示许可人为您或您的使用背书。  
- **非商业性使用** — 您不得将本作品用于商业目的。  
- **合理引用方式** — 可在代码注释、文档、演示视频或项目说明中明确来源。  

**版权归 FreakStudio 所有。**

    